<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPFHRA - Check Report</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <style>
        
        body {
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #0D1B2A, #1B263B, #415A77);
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-size: cover;
    color: #ffffff;
    min-height: 100vh;
    line-height: 1.6;
    overflow-x: hidden;
}

.main-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.user-info-section {
    text-align: center;
    margin-bottom: 40px;
}

.logo-container {
    padding: 10px;
    margin-bottom: 20px;
}

.logo {
    width: 150px;
    height: auto;
    border-radius: 50%;
    border: 3px solid #E0E1DD;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    background: white;
}

#user-name {
    font-size: 2.5rem;
    font-weight: 600;
    margin-bottom: 5px;
    color: #F6F6F6;
}

#user-location {
    font-size: 1.2rem;
    color: #B0B0B0;
    margin-top: 0;
}

#message-to-user {
    font-style: italic;
    color: #A0A0A0;
    max-width: 600px;
    margin: 20px auto;
}


.reports-list-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
}
.report-card {
    background-color: #1B263B;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    cursor: pointer;
    border-left: 5px solid #E0E1DD;
}

.report-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
}

.report-card h3 {
    margin: 0 0 10px;
    color: #E0E1DD;
    font-size: l.em;
}

.report-card p {
    margin: 5px 0;
    color: #B0B0B0;
}

.report-card small {
    display: block;
    margin-top: 15px;
    color: #8D99AE;
    font-style: italic;
}



.modal, .media-modal, .audio-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%; 
    background-color: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
    overflow-y: auto; 
    padding: 20px 0;
    box-sizing: border-box;
}

.modal-content, .media-content, .audio-content {
    position: relative;
    background: #0D1B2A;
    padding: 30px;
    border-radius: 10px;
    width: 90%;
    max-width: 800px;
    box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
    max-height: 95vh;
    overflow-y: auto; 
    box-sizing: border-box;
}

.close-btn, .close-media-btn, .close-audio-btn {
    position: sticky; 
    top: 0;
    right: 0;
    z-index: 1001; 
    color: #ffffff;
    font-size: 35px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
    background: #0D1B2A; 
    padding: 5px 15px; 
    border-radius: 0 0 5px 5px;
    float: right; 
}


.close-btn:hover, .close-btn:focus,
.close-media-btn:hover, .close-media-btn:focus,
.close-audio-btn:hover, .close-audio-btn:focus {
    color: #E0E1DD;
}


.report-paper-container {
    background: #ffffff;
    color: #333333;
    width: 100%;
    padding: 40px;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
    line-height: 1.5;
    font-weight: 700;
}

.report-paper-container h1, .report-paper-container h2, .report-paper-container h3 {
    color: #0D1B2A;
    font-weight: 700;
    Text-align: center;
    font-size: 20px;
}




.report-paper-header .logo {
    width: 80px;
    height: auto;
    border: none;
    box-shadow: none;
    margin-right: 15px;
}

.report-paper-header h1 {
    font-size: 15px;
    font-weight: 600;
    margin: 0;
    flex-grow: 1;
    line-height: 1.5;
}

.report-paper-meta {
    text-align: right;
    font-size: 0.9rem;
    color: #555;
   line-height: 1.5;
}

.report-content {
    margin: 20px 0;
}

.report-content p {
    font-size: 1rem;
    text-align: justify;
    font-weight: 700;
    
}


.report-details div {
    flex: 1 1 200px;
}

.report-details strong {
    color: #0D1B2A;
}

.media-section {
    margin-top: 40px;
    text-align: center;
    padding: 20px;
    border-radius: 8px;
    background-color: #1B263B;
}

.media-section h3 {
    color: #E0E1DD;
    margin-bottom: 20px;
}

.media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    justify-content: center;
}

.media-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

.media-item img, .media-item video {
    width: 100%;
    height: 150px;
    object-fit: cover;
    display: block;
}

.media-item .play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    color: #ffffff;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    opacity: 0.8;
}


#audio-player-container {
    padding: 20px;
    background-color: #1B263B;
    border-radius: 8px;
}

#audio-player-container audio {
    width: 100%;
    outline: none;
}


.report-buttons {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px dashed #B0B0B0;
}

.action-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: background-color 0.3s, transform 0.2s;
    color: #E0E1DD;
    display: flex;
    align-items: center;
    gap: 8px;
}

.action-btn i {
    font-size: 1.1rem;
}

.btn-delete {
    background-color: #E53935;
}

.btn-complete {
    background-color: #4CAF50;
}

.btn-pdf {
    background-color: #1A73E8;
}

.btn-print {
    background-color: #616161;
}

.action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}


.notification-container {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #4CAF50;
    color: #fff;
    padding: 15px 30px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
}

.notification-container.error {
    background-color: #E53935;
}

.notification-container.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}


.hidden {
    display: none;
}


@media print {
    body {
        background: none;
        color: #000;
    }
    .main-container, .reports-list-container, .media-section, .report-buttons, .notification-container, .modal .close-btn {
        display: none !important;
    }
    .modal {
        display: block !important;
        position: static !important;
        background: none !important;
        box-shadow: none !important;
    }
    .modal-content, .report-paper-container {
        width: 100% !important;
        max-width: 100% !important;
        background: #fff !important;
        box-shadow: none !important;
        color: #000 !important;
        padding: 0 !important;
    }
}


@media (max-width: 768px) {
    .main-container {
        padding: 10px;
    }
    .logo {
        width: 120px;
    }
    #user-name {
        font-size: 2rem;
    }
    #user-location {
        font-size: 1rem;
    }
    .report-card {
        padding: 20px;
    }
    .report-paper-container {
        padding: 20px;
    }
    .report-paper-header h1 {
        font-size: 1.4rem;
    }
    .report-buttons {
        flex-direction: column;
    }
    .action-btn {
        width: 100%;
    }
}
    </style>
</head>
<body>

    <div id="notification-container" class="notification-container hidden">
        <p id="notification-message"></p>
    </div>

    <div class="main-container">
        <div class="user-info-section">
            <div class="logo-container">
                <img src="https://i.imgur.com/lwddsvh.png" alt="LPFHRA Logo" class="logo">
            </div>
            <div id="user-info">
                <h2 id="user-name"></h2>
                <p id="user-location"></p>
                <p id="message-to-user">You have reports from your locality. Please investigate or forward to the appropriate authority. We appreciate your dedication, LPFHRA Member.</p>
            </div>
        </div>

        <div id="reports-list-container" class="reports-list-container">
            </div>

        <div id="report-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn"><i class="fas fa-times"></i></span>
                <div class="report-paper-container" id="report-paper">
                    </div>
            </div>
        </div>
        
        <div id="media-modal" class="media-modal hidden">
            <div class="media-content">
                <span class="close-media-btn"><i class="fas fa-times"></i></span>
                <div id="media-viewer">
                    </div>
                <button id="download-media-btn" class="download-media-btn"><i class="fas fa-download"></i> Download</button>
            </div>
        </div>
        
        <div id="audio-modal" class="audio-modal hidden">
            <div class="audio-content">
                <span class="close-audio-btn"><i class="fas fa-times"></i></span>
                <div id="audio-player-container">
                    </div>
            </div>
        </div>
    </div>

<center>
    <footer class="footer">
        <div class="container">
            <p>&copy; LPFHRA. All rights reserved.</p>
            <p>Reg. 7373969</p>
            <p>For inquiries, please contact us at: <a href="mailto:leawaypeacefoundation@gmail.com ">info@lpfhra.org</a></p>
        </div>
    </footer>
</center>
    <script type="module">
        
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getDatabase, ref, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
import { app } from './firebase.js';

const reportsListContainer = document.getElementById('reports-list-container');
const reportModal = document.getElementById('report-modal');
const mediaModal = document.getElementById('media-modal');
const audioModal = document.getElementById('audio-modal');
const notificationContainer = document.getElementById('notification-container');
const notificationMessage = document.getElementById('notification-message');

const auth = getAuth(app);
const db = getDatabase(app);


document.querySelector('.close-btn').addEventListener('click', () => reportModal.style.display = 'none');
document.querySelector('.close-media-btn').addEventListener('click', () => mediaModal.style.display = 'none');
document.querySelector('.close-audio-btn').addEventListener('click', () => {
    document.getElementById('audio-player-container').innerHTML = ''; 
    audioModal.style.display = 'none';
});


window.addEventListener('click', (event) => {
    if (event.target === reportModal) reportModal.style.display = 'none';
    if (event.target === mediaModal) mediaModal.style.display = 'none';
    if (event.target === audioModal) {
        document.getElementById('audio-player-container').innerHTML = '';
        audioModal.style.display = 'none';
    }
});


function showNotification(message, isError = false) {
    notificationMessage.textContent = message;
    notificationContainer.classList.remove('error', 'show');
    if (isError) {
        notificationContainer.classList.add('error');
    }
    notificationContainer.classList.add('show');
    setTimeout(() => {
        notificationContainer.classList.remove('show');
    }, 5000); 
}


function formatDateTime(isoString) {
    const date = new Date(isoString);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return date.toLocaleDateString('en-US', options);
}


function renderReportPaper(report, reportId) {
    const reportPaper = document.getElementById('report-paper');
    reportPaper.innerHTML = ''; 

    const reportDate = formatDateTime(report.reportTime);

   
    const header = document.createElement('div');
    header.className = 'report-paper-header';
    header.innerHTML = `
        <img src="https://i.imgur.com/lwddsvh.png" alt="LPFHRA Logo" class="logo">
        <div>
            <h1>Leadway Peace Functions and Human Rights Aids</h1>
            <h2>Report Paper</h2>
        </div>
        <div class="report-paper-meta">
            <p><strong>Date:</strong> ${reportDate}</p>
            <p><strong>From:</strong> ${report.country}, ${report.state}, ${report.lga}</p>
        </div>
    `;
    reportPaper.appendChild(header);

   
    const details = document.createElement('div');
    details.className = 'report-details';
    details.innerHTML = `
        <div><strong>Name:</strong> ${report.fullName}</div>
        <div><strong>Phone:</strong> ${report.phoneNumber}</div>
        <div><strong>Gender:</strong> ${report.gender}</div>
        <div><strong>Country:</strong> ${report.country}</div>
        <div><strong>State:</strong> ${report.state}</div>
        <div><strong>LGA:</strong> ${report.lga}</div>
    `;
    reportPaper.appendChild(details);

  
    const reportTextSection = document.createElement('div');
    reportTextSection.className = 'report-content';
    reportTextSection.innerHTML = `
        <h3>Report Details</h3>
        <p>${report.reportText}</p>
    `;
    reportPaper.appendChild(reportTextSection);

    
    const mediaSection = document.createElement('div');
    mediaSection.className = 'media-section';
    mediaSection.innerHTML = `<h3>Attachments</h3><div class="media-grid"></div>`;
    const mediaGrid = mediaSection.querySelector('.media-grid');
    
   
    function handleMediaClick(url, type) {
        if (type === 'audio') {
            const audioPlayerContainer = document.getElementById('audio-player-container');
            audioPlayerContainer.innerHTML = `<audio controls autoplay><source src="${url}" type="audio/mpeg"></audio>`;
            audioModal.style.display = 'flex';
        } else {
            const mediaViewer = document.getElementById('media-viewer');
            mediaViewer.innerHTML = '';
            const downloadBtn = document.getElementById('download-media-btn');
            downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.href = url;
                link.download = `${report.fullName}_${type}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification(`Download started for the ${type}.`, false);
            };

            if (type === 'image') {
                const img = document.createElement('img');
                img.src = url;
                mediaViewer.appendChild(img);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                video.setAttribute('playsinline', '');
                video.setAttribute('webkit-playsinline', '');
                video.style.width = '100%';
                mediaViewer.appendChild(video);
            }
            mediaModal.style.display = 'flex';
        }
    }

   
    if (report.imageLinks && Array.isArray(report.imageLinks) && report.imageLinks.length > 0) {
        report.imageLinks.forEach(link => {
            const imgItem = document.createElement('div');
            imgItem.className = 'media-item';
            imgItem.innerHTML = `<img src="${link}" alt="Report Image">`;
            imgItem.addEventListener('click', () => handleMediaClick(link, 'image'));
            mediaGrid.appendChild(imgItem);
        });
    }

   
    if (report.videoLinks && Array.isArray(report.videoLinks) && report.videoLinks.length > 0) {
        report.videoLinks.forEach(link => {
            const videoItem = document.createElement('div');
            videoItem.className = 'media-item';
            videoItem.innerHTML = `<video src="${link}"></video><i class="fas fa-play play-icon"></i>`;
            videoItem.addEventListener('click', () => handleMediaClick(link, 'video'));
            mediaGrid.appendChild(videoItem);
        });
    }

   
    if (report.audioLinks && Array.isArray(report.audioLinks) && report.audioLinks.length > 0) {
        report.audioLinks.forEach(link => {
            const audioItem = document.createElement('div');
            audioItem.className = 'media-item';
            audioItem.innerHTML = `<i class="fas fa-volume-up play-icon"></i>`;
            audioItem.addEventListener('click', () => handleMediaClick(link, 'audio'));
            mediaGrid.appendChild(audioItem);
        });
    }
    
    
    if (mediaGrid.children.length > 0) {
        reportPaper.appendChild(mediaSection);
    }
    
   
    const buttonsSection = document.createElement('div');
    buttonsSection.className = 'report-buttons';
    buttonsSection.innerHTML = `
        <button id="delete-btn" class="action-btn btn-delete"><i class="fas fa-trash-alt"></i> Delete Report</button>
        <button id="complete-btn" class="action-btn btn-complete"><i class="fas fa-check-circle"></i> Mark as Complete</button>
        <button id="save-pdf-btn" class="action-btn btn-pdf"><i class="fas fa-file-pdf"></i> Save to PDF</button>
        <button id="print-btn" class="action-btn btn-print"><i class="fas fa-print"></i> Print</button>
    `;
    reportPaper.appendChild(buttonsSection);

   
    document.getElementById('delete-btn').addEventListener('click', () => deleteReport(reportId));
    document.getElementById('complete-btn').addEventListener('click', () => markAsComplete(reportId, report.fullName));
    document.getElementById('save-pdf-btn').addEventListener('click', () => saveToPdf(report.fullName, reportId, report.imageLinks));
    document.getElementById('print-btn').addEventListener('click', () => printReport());

    reportModal.style.display = 'flex';
}


async function deleteReport(reportId) {
    const confirmDelete = window.confirm('Are you sure you want to permanently delete this report? This action cannot be undone.');
    if (!confirmDelete) return;
    try {
        const reportRef = ref(db, `Reports/${reportId}`);
        await remove(reportRef);
        showNotification('Report deleted successfully!', false);
        reportModal.style.display = 'none';
    } catch (error) {
        console.error("Error deleting report: ", error);
        showNotification('Failed to delete report. Please try again.', true);
    }
}


async function markAsComplete(reportId, userName) {
    const reportRef = ref(db, `Reports/${reportId}`);
    try {
        await update(reportRef, { status: 'complete' });
        showNotification(`This report has been marked as complete and is now assigned to you, ${userName}. It will no longer be visible to other members.`, false);
        reportModal.style.display = 'none';
    } catch (error) {
        console.error("Error marking report as complete: ", error);
        showNotification('Failed to mark report as complete. Please try again.', true);
    }
}


function saveToPdf(userName, reportId, imageLinks) {
    const element = document.getElementById('report-paper');
    const pdfOptions = {
        margin: 10,
        filename: `${userName}_Report_${reportId}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
   
    const validImageLinks = (imageLinks && Array.isArray(imageLinks)) ? imageLinks : [];

   
    const imgPromises = validImageLinks.map(link => new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = link;
    }));
    
    Promise.all(imgPromises).then(images => {
        const imgSection = document.createElement('div');
        images.filter(img => img).forEach(img => {
            const imgDiv = document.createElement('div');
            imgDiv.style.textAlign = 'center';
            imgDiv.style.marginTop = '20px';
            const imgClone = img.cloneNode();
            imgClone.style.maxWidth = '100%';
            imgDiv.appendChild(imgClone);
            imgSection.appendChild(imgDiv);
        });
        element.appendChild(imgSection);

        html2pdf().from(element).set(pdfOptions).save().then(() => {
            element.removeChild(imgSection); // Clean up the temporary image section
            showNotification('PDF downloaded successfully!', false);
        }).catch(error => {
            element.removeChild(imgSection);
            console.error('Error generating PDF:', error);
            showNotification('Failed to save PDF. Please try again.', true);
        });
    });
}


function printReport() {
    window.print();
}


onAuthStateChanged(auth, (user) => {
    if (user) {
        const userRef = ref(db, `users/${user.uid}`);
        get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
                const userData = snapshot.val();
                document.getElementById('user-name').textContent = `${userData.fullName} (${userData.position})`;
                document.getElementById('user-location').textContent = `${userData.country}, ${userData.state}, ${userData.lga}`;
                
                const reportsRef = ref(db, 'Reports');
                onValue(reportsRef, (reportsSnapshot) => {
                    reportsListContainer.innerHTML = '';
                    const allReports = reportsSnapshot.val();
                    const reportsArray = allReports ? Object.keys(allReports).map(key => ({ id: key, ...allReports[key] })) : [];

                    const localReports = reportsArray.filter(report =>
                        report.country === userData.country &&
                        report.state === userData.state &&
                        report.status !== 'complete'
                    );

                    const otherReports = reportsArray.filter(report =>
                        (report.country !== userData.country || report.state !== userData.state) &&
                        report.status !== 'complete'
                    );

                    if (localReports.length > 0) {
                        document.getElementById('message-to-user').textContent = 'You have reports from your locality. Please investigate or forward to the appropriate authority. We appreciate your dedication, LPFHRA Member.';
                        localReports.forEach(report => createReportCard(report, report.id));
                        showNotification(`You have ${localReports.length} report(s) in your area.`, false);
                    } else if (otherReports.length > 0) {
                        document.getElementById('message-to-user').textContent = 'No reports found in your locality. The following reports are from other areas.';
                        otherReports.forEach(report => createReportCard(report, report.id));
                        showNotification('No reports found near you. Displaying reports from other areas.', false);
                    } else {
                        reportsListContainer.innerHTML = '<p class="no-reports-message">No new reports available at this time. Thank you for your service.</p>';
                    }
                });
            } else {
                showNotification("User data not found.", true);
                signOut(auth);
            }
        }).catch((error) => {
            console.error("Error fetching user data: ", error);
            showNotification("Failed to load user data.", true);
            signOut(auth);
        });
    } else {
        
        window.location.href = 'login.html'; 
    }
});


function createReportCard(report, id) {
    const reportCard = document.createElement('div');
    reportCard.className = 'report-card';
    reportCard.innerHTML = `
        <h3>${report.reportText.substring(0, 50)}...</h3>
        <p><strong>Reporter:</strong> ${report.fullName}</p>
        <p><strong>Location:</strong> ${report.lga}, ${report.state}</p>
        <small>Reported on: ${formatDateTime(report.reportTime)}</small>
    `;
    reportCard.addEventListener('click', () => renderReportPaper(report, id));
    reportsListContainer.appendChild(reportCard);
}
    </script>
</body>
</html>
