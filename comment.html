<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Comments</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* üôè‚úîÔ∏èSite 1 ya fara daga nan ‚úîÔ∏è*/
        body {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0D1B2A, #1B263B, #415A77);
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            color: #ffffff;
            min-height: 100vh;
            line-height: 1.6;
            padding-bottom: 120px;
            overflow-x: hidden;
        }
        #comment-page-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        #post-display-container {
            
            
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .post-profile-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #6c757d;
            cursor: pointer;
        }
        .post-author-info {
            display: flex;
            flex-direction: column;
        }
        .post-author-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .post-author-meta {
            font-size: 0.8em;
            color: #b0b0b0;
        }
        .post-text {
            white-space: pre-wrap;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .post-media-container {
            display: grid;
            gap: 5px;
            margin-top: 15px;
        }
        .post-media-container.grid-1 { grid-template-columns: 1fr; }
        .post-media-container.grid-2 { grid-template-columns: 1fr 1fr; }
        .post-media-container.grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .post-media-container.grid-4 { grid-template-columns: 1fr 1fr; }
        .post-media-container.grid-5 { grid-template-columns: 1fr 1fr; }
        .post-media-container.grid-5 img:first-child { grid-column: 1 / 3; }
        .post-media-item {
            width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            display: block;
        }
        .post-video-container, .post-audio-container {
            width: 100%;
            height: auto;
            border-radius: 8px;
            overflow: hidden;
        }
        .post-video-container video, .post-video-container iframe {
            width: 100%;
            height: 300px;
            border: none;
        }
        .post-audio-container audio {
            width: 100%;
        }
        #all-comments-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        /* Sabon style na 'read more' */
        .read-more-text {
            color: #E0E1DD;
            cursor: pointer;
            font-style: italic;
            text-decoration: underline;
        }
        /* üôè‚úîÔ∏èSite 1 ya kare daga nan ‚úîÔ∏è*/
        /* üôè‚úîÔ∏èSite 2 ya fara daga nan ‚úîÔ∏è*/
        #comment-input-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #212F45;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            box-sizing: border-box;
            z-index: 999;
        }
        #reply-to-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #415A77;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        #reply-to-container.hidden { display: none; }
        #reply-to-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
            overflow: hidden;
            gap: 3px;
        }
        #reply-to-profile-photo {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            background: white;
        }
        #reply-to-text-container {
            display: flex;
            flex-direction: column;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #reply-to-name {
            font-weight: bold;
            font-size: 0.9em;
        }
        #reply-to-message {
            font-size: 0.8em;
            color: #E0E1DD;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #cancel-reply-btn {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            font-size: 1.2em;
        }
        #comment-input-box-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #visitor-name-input {
            width: 100%;
            background-color: #0D1B2A;
            color: #ffffff;
            border: 1px solid #415A77;
            border-radius: 20px;
            padding: 8px 15px;
            box-sizing: border-box;
        }
        #comment-input-box {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        #comment-textarea {
            width: 100%;
            background-color: #0D1B2A;
            color: #ffffff;
            border: 1px solid #415A77;
            border-radius: 20px;
            padding: 10px 15px;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
            transition: height 0.2s;
            box-sizing: border-box;
        }
        #add-media-btn, #send-comment-btn, #emoji-btn {
            background-color: #415A77;
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2em;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        #add-media-btn:hover, #send-comment-btn:hover, #emoji-btn:hover {
            transform: scale(1.1);
        }
        #send-comment-btn.send-btn-active {
            background-color: #E0E1DD;
            color: #0D1B2A;
            animation: pulse 1s infinite;
        }
        #send-comment-btn.send-btn-inactive {
            cursor: not-allowed;
            opacity: 0.5;
            animation: none;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        #media-preview-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .media-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
        }
        .media-preview-item img, .media-preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .remove-media-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8em;
            z-index: 10;
        }
        #notification-container {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
            z-index: 1000;
        }
        #notification-container.show {
            opacity: 1;
            bottom: 130px;
        }
        #image-viewer-modal, #profile-viewer-modal, #full-screen-video-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: opacity 0.3s;
            opacity: 0;
            pointer-events: none;
        }
        #image-viewer-modal.visible, #profile-viewer-modal.visible, #full-screen-video-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #image-viewer-img, #profile-viewer-main-img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        #profile-viewer-content {
            position: relative;
        }
        #profile-viewer-support-img {
            position: absolute;
            bottom: -15px;
            right: -15px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid white;
            object-fit: cover;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .close-btn, #image-viewer-download-btn, #video-toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2em;
            cursor: pointer;
            background: none;
            border: none;
            z-index: 1002;
        }
        #image-viewer-download-btn {
            top: 60px;
        }
        #video-toggle-btn {
            right: 80px;
        }
        #full-screen-video-player {
            width: 100%;
            height: 100%;
        }
        /* üôè‚úîÔ∏èSite 2 ya kare daga nan ‚úîÔ∏è*/
        /* üôè‚úîÔ∏èSite 3 ya fara daga nan ‚úîÔ∏è*/
        .comment-card {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 5px;
            position: relative;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            gap: 3px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .comment-card.is-reply {
        background-color: #212F45;
            margin-left: 70px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 2px solid #415A77;
            padding-left: 20px;
            
        }
        .comment-card.my-comment {
            border: 2px solid #6c757d;
            
        }
       
        .comment-card:hover .comment-options-menu {
            display: flex;
        }
        .comment-options-menu {
            position: absolute;
            top: 7px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            padding: 5px;
            display: none;
            flex-direction: column; 
            gap: 5px;
            z-index: 10;
        }
        .comment-options-menu button {
            background: none;
            border: 5px;
            color: white;
            cursor: pointer;
            padding: 5px;
            text-align: left;
        }
        .comment-options-menu button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .comment-card:hover {
            transform: translateY(-2px);
        }
        .comment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .comment-header-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .comment-profile-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            background: white;
        }
        .comment-user-name {
            font-weight: bold;
            font-size: 0.9em;
        }
        .comment-time {
            font-size: 0.7em;
            color: #b0b0b0;
            margin-left: auto;
        }
        .comment-content {
            margin-bottom: 10px;
        }
        .comment-text {
            white-space: pre-wrap;
            line-height: 1.3;
            word-wrap: break-word;
        }
        .comment-media-container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .comment-media-item {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
        }
        /* Sabon style na comment actions */
        .comment-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1em;
            color: #b0b0b0;
        }
        .comment-action-btn {
            background: none;
            border: none;
            color: #b0b0b0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }
        .comment-action-btn:hover {
            color: #ffffff;
        }
        .comment-action-btn.active {
            color: #E0E1DD;
        }
        .comment-action-btn.like-btn.liked {
            color: #FF6347; 
        }
        .comment-actions .emoji-dropdown {
            position: relative;
        }
        .comment-actions .emoji-dropdown-content {
            position: absolute;
            bottom: 100%;
            left: 0;
            background-color: #212F45;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            padding: 5px;
            display: none;
            gap: 5px;
            z-index: 100;
        }
        .comment-actions .emoji-dropdown-content.show {
            display: flex;
        }
        .comment-actions .emoji-dropdown-content button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
        }
        .emoji-counts {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .emoji-count-item {
            background-color: #1B263B;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 1.7em;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .emoji-count-item:hover {
            transform: scale(1.1);
        }
        .emoji-picker-container {
            display: none;
            position: fixed;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #212F45;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            flex-wrap: wrap;
            gap: 5px;
            width: 300px;
            z-index: 1000;
        }
        .emoji-picker-container.visible {
            display: flex;
        }
        .emoji-picker-container button {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }
        .emoji-picker-container button:hover {
            transform: scale(1.1);
        }
        .status-icon {
            color: #4CAF50;
            margin-left: auto;
            font-size: 1.2em;
        }
        .pending-icon {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .replies-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            border-left: 2px solid #415A77;
            padding-left: 20px;
           border-top: 1px solid rgba(255, 255, 255, 0.1);
  
}
        .replies-container.is-reply {
            margin-left: 20px;
            border-left: 2px solid #415A77;
            padding-left: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .replies-container .comment-card {
            background-color: #1B263B;
            border: none;
          
        }
        .replies-container .comment-card:hover .comment-options {
            display: none;
        }
        /* Sabon style na notification */
        #push-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
            z-index: 2000;
        }
        #push-notification.show {
            opacity: 1;
            top: 30px;
        }
        /* üôè‚úîÔ∏èSite 3 ya kare daga nan ‚úîÔ∏è*/
        /* General Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal.visible {
            display: flex;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-title {
            margin-top: 0;
            color: #333;
        }
        .modal-message {
            margin-bottom: 20px;
            color: #555;
        }
        .modal-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .modal-actions {
            display: flex;
            justify-content: space-around;
        }
        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-actions .confirm-btn {
            background-color: #007bff;
            color: white;
        }
        .modal-actions .cancel-btn {
            background-color: #f44336;
            color: white;
        }
        /* Notification Styles */
        #notification-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #notification-container.show {
            opacity: 1;
            visibility: visible;
        }
      
    </style>
</head>
<body>
    <div id="comment-page-container">
        <div id="post-display-container">
        </div>
        </div>
        <div id="all-comments-container">
        </div>
    </div>
    <footer id="comment-input-footer">
        <div id="reply-to-container" class="hidden">
            <div id="reply-to-info">
                
                <div id="reply-to-text-container">
                    <span id="reply-to-name"></span>
                    <span id="reply-to-message"></span>
                </div>
            </div>
            <button id="cancel-reply-btn"><i class="fas fa-times"></i></button>
        </div>
        <div id="comment-input-box-container">
            <input type="text" id="visitor-name-input" placeholder="Input your name">
            <div id="comment-input-box">
                <button id="add-media-btn"><i class="fas fa-plus"></i></button>
                <textarea id="comment-textarea" placeholder="Write a comment..."></textarea>
                <button id="send-comment-btn" class="send-btn-inactive"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div id="media-preview-container">
        </div>
        <div id="input-modal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title"></h3>
                <p class="modal-message"></p>
                <input type="text" class="modal-input" />
                <div class="modal-actions">
                    <button class="confirm-btn">Confirm</button>
                    <button class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
        <div id="confirmation-modal" class="modal">
            <div class="modal-content">
                <p class="modal-message"></p>
                <div class="modal-actions">
                    <button class="confirm-btn">Yes, Delete</button>
                    <button class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
        <div id="notification-container"></div>
        <div id="emoji-picker-container" class="emoji-picker-container">
            <button class="emoji-icon close-emoji-btn">‚ùå</button>
            <button class="emoji-icon">üëç</button>
            <button class="emoji-icon">‚ù§Ô∏è</button>
            <button class="emoji-icon">üòÇ</button>
            <button class="emoji-icon">üíØ</button>
            <button class="emoji-icon">üòä</button>
            <button class="emoji-icon">üòé</button>
            <button class="emoji-icon">üò≠</button>
            <button class="emoji-icon">ü§î</button>
            <button class="emoji-icon">ü§¶‚Äç‚ôÄÔ∏è</button>
            <button class="emoji-icon">üéâ</button>
            <button class="emoji-icon">üôè</button>
        </div>
    </footer>
    <div id="image-viewer-modal" class="modal">
        <span class="close-btn">&times;</span>
        <img id="image-viewer-img" src="" alt="View Image">
        <button id="image-viewer-download-btn"><i class="fas fa-download"></i></button>
    </div>
    <div id="profile-viewer-modal" class="modal">
        <span class="close-btn">&times;</span>
        <div id="profile-viewer-content">
            <img id="profile-viewer-main-img" src="" alt="Profile Photo">
            <img id="profile-viewer-support-img" src="" alt="Support Team" class="profile-support-icon">
        </div>
    </div>
    <div id="notification-container"></div>
    <div id="full-screen-video-modal" class="modal">
        <span class="close-btn"><i class="fas fa-times"></i></span>
        <div id="full-screen-video-player"></div>
        <button id="video-toggle-btn"><i class="fas fa-expand"></i></button>
    </div>
    <div id="push-notification"></div>
    



 <script type="module">
    import { app, analytics, firebaseConfig } from './firebase.js';
    import { getDatabase, ref, get, set, push, update, remove, child, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    /* Global Variables - An …óauko su daga cikin DOMContentLoaded don gyara errors */
    const db = getDatabase();
    let postId = null;
    let postData = null;
    let postOwnerUid = null;
    let commentsCache = [];
    const MAX_COMMENT_TEXT_LENGTH = 150;
    let localUserId = localStorage.getItem('localUserId');

    // Variables don Ayyukan Comment da Reply
    const commentPageContainer = document.getElementById('comment-page-container');
    const postDisplayContainer = document.getElementById('post-display-container');
    const allCommentsContainer = document.getElementById('all-comments-container');
    const visitorNameInput = document.getElementById('visitor-name-input');
    const addMediaBtn = document.getElementById('add-media-btn');
    const commentTextarea = document.getElementById('comment-textarea');
    const sendCommentBtn = document.getElementById('send-comment-btn');
    const mediaPreviewContainer = document.getElementById('media-preview-container');
    const replyToContainer = document.getElementById('reply-to-container');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    const emojis = ['üëç', 'ü§¶‚Äç‚ôÄÔ∏è', 'üëÅÔ∏è', '‚ùå', 'üôÜ‚Äç‚ôÇÔ∏è', 'ü§ö', 'ü§ú', 'üòÜ', 'üòÑ', 'üò†', 'üò°', 'üëπ', 'üôâ', 'üíû', '‚ù§Ô∏è', 'üíØ', 'üí•', 'üë©‚Äçüé§', 'üë©‚Äçüåæ', 'üôã‚Äç‚ôÄÔ∏è', 'üêí', 'ü¶ç', 'üê´', 'ü¶ì', 'ü¶Ñ', 'üêü', '‚öΩ', 'üèÖ', 'üèÜ', 'ü•á', 'üéâ', 'üéä', 'üéÅ'];
    
    let selectedMediaFiles = [];
    let replyingToOriginalCommentId = null;
    let replyingToParentReplyId = null;
    let replyingToUserFullName = null;

    if (!localUserId) {
        localUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('localUserId', localUserId);
    }
    console.log("Current user Local ID:", localUserId);

    /* --- Site 1: Post Display da Basic Functions --- */
    
    async function loadPostAndComments() {
        const urlParams = new URLSearchParams(window.location.search);
        postId = urlParams.get('postId');

        if (!postId) {
            showNotification("Error: Post ID not found in URL.");
            return;
        }
        
        const usersRef = ref(db, 'users');
        onValue(usersRef, (snapshot) => {
            const users = snapshot.val();
            if (users) {
                let postFound = false;
                for (const uid in users) {
                    if (users[uid].Posting && users[uid].Posting[postId]) {
                        postData = { ...users[uid].Posting[postId], postId, uid };
                        postOwnerUid = uid;
                        renderSinglePost(postData);
                        listenCommentsRealtime();
                        postFound = true;
                        break;
                    }
                }
                if (!postFound) {
                    showNotification("Post not found.");
                }
            }
        });
    }

    function renderSinglePost(post) {
        if (!postDisplayContainer) return;
        postDisplayContainer.innerHTML = `
            <div class="post-header">
                <img src="${post.profilePhoto || 'https://i.imgur.com/lwddsvh.png'}" alt="Profile" class="post-profile-photo" data-profile-photo="${post.profilePhoto}" data-support-team="${post.supportTeams || ''}">
                <div class="post-author-info">
                    <span class="post-author-name">${post.fullName}</span>
                    <span class="post-author-meta">${post.country || ''}, ${post.state || ''} &bull; ${formatTime(post.postingTime)}</span>
                </div>
            </div>
            ${renderPostText(post.text)}
            ${renderPostMedia(post)}
        `;
        postDisplayContainer.querySelector('.post-profile-photo').addEventListener('click', (e) => {
            const img = e.target;
            openProfileViewer(img.dataset.profilePhoto, img.dataset.supportTeam);
        });
        postDisplayContainer.querySelectorAll('.post-media-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const src = e.target.src;
                openImageViewer(src);
            });
        });
        postDisplayContainer.querySelectorAll('.post-video-container video').forEach(video => {
            video.addEventListener('click', (e) => {
                openVideoViewer(e.target.src);
            });
        });
        
        const postReadMoreBtn = postDisplayContainer.querySelector('.read-more');
        if (postReadMoreBtn) {
            postReadMoreBtn.addEventListener('click', () => {
                const fullText = decodeURIComponent(postDisplayContainer.querySelector('.post-text-container').dataset.fulltext);
                postDisplayContainer.querySelector('.post-text').textContent = fullText;
                postReadMoreBtn.style.display = 'none';
            });
        }
    }

    function renderPostText(text) {
        if (!text) return '';
        let displayPostText = text;
        let hasMorePostText = false;
        if (text.length > MAX_COMMENT_TEXT_LENGTH) {
            displayPostText = text.substring(0, MAX_COMMENT_TEXT_LENGTH) + '...';
            hasMorePostText = true;
        }
        return `
            <div class="post-text-container" data-fulltext="${encodeURIComponent(text)}">
                <p class="post-text">${displayPostText}</p>
                ${hasMorePostText ? `<span class="read-more">Read More</span>` : ''}
            </div>
        `;
    }

    function renderPostMedia(post) {
        const postPhotos = [];
        if (post.photoLink1) postPhotos.push(post.photoLink1);
        if (post.photoLink2) postPhotos.push(post.photoLink2);
        if (post.photoLink3) postPhotos.push(post.photoLink3);
        if (post.photoLink4) postPhotos.push(post.photoLink4);
        if (post.photoLink5) postPhotos.push(post.photoLink5);
        
        if (post.videoLink) {
            return `<div class="post-video-container"><video src="${post.videoLink}" controls></video></div>`;
        } else if (post.audioLink) {
            const photosHtml = postPhotos.map(url => `<img src="${url}" alt="Post Image" class="post-media-item">`).join('');
            return `
                <div class="post-media-container grid-${postPhotos.length}">${photosHtml}</div>
                <div class="post-audio-container"><audio controls src="${post.audioLink}"></audio></div>
            `;
        } else if (postPhotos.length > 0) {
            const photosHtml = postPhotos.map(url => `<img src="${url}" alt="Post Image" class="post-media-item">`).join('');
            return `<div class="post-media-container grid-${postPhotos.length}">${photosHtml}</div>`;
        }
        return '';
    }

    function formatTime(timestamp) {
        if (!timestamp) return '';
        const now = new Date();
        const postDate = new Date(timestamp);
        const diffInSeconds = Math.floor((now - postDate) / 1000);
        
        if (diffInSeconds < 60) return `${diffInSeconds} seconds ago`;
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
        return postDate.toLocaleDateString();
    }

    function showNotification(message) {
        const notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) return;
        notificationContainer.textContent = message;
        notificationContainer.classList.add('show');
        setTimeout(() => {
            notificationContainer.classList.remove('show');
        }, 3000);
    }
    
    function openImageViewer(src) {
        const modal = document.getElementById('image-viewer-modal');
        const img = document.getElementById('image-viewer-img');
        const downloadBtn = document.getElementById('image-viewer-download-btn');
        if (!modal || !img || !downloadBtn) return;
        img.src = src;
        downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = src;
            a.download = 'image.jpg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        modal.classList.add('visible');
    }

    function openVideoViewer(src) {
        const modal = document.getElementById('full-screen-video-modal');
        const player = document.getElementById('full-screen-video-player');
        if (!modal || !player) return;
        player.innerHTML = `<video src="${src}" controls autoplay></video>`;
        modal.classList.add('visible');
    }
    
    function openProfileViewer(profilePhoto, supportTeam) {
        const modal = document.getElementById('profile-viewer-modal');
        const mainImg = document.getElementById('profile-viewer-main-img');
        const supportImg = document.getElementById('profile-viewer-support-img');
        if (!modal || !mainImg || !supportImg) return;
        mainImg.src = profilePhoto;
        supportImg.src = supportTeam || '';
        modal.classList.add('visible');
    }
    
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('visible'));
        });
    });

    /* --- Site 2: Comment Input and Upload Logic --- */

    document.addEventListener('DOMContentLoaded', function() {
        const mediaFileInput = document.createElement('input');
        mediaFileInput.type = 'file';
        mediaFileInput.multiple = true;
        mediaFileInput.accept = 'image/*,video/*';
        mediaFileInput.style.display = 'none';
        document.body.appendChild(mediaFileInput);
        
        visitorNameInput.value = localStorage.getItem('userName') || '';
        
        if (commentTextarea) {
            commentTextarea.addEventListener('input', () => {
                commentTextarea.style.height = 'auto';
                commentTextarea.style.height = commentTextarea.scrollHeight + 'px';
                checkInput();
            });
        }
        if (visitorNameInput) {
            visitorNameInput.addEventListener('input', checkInput);
        }
        
        function checkInput() {
            if (commentTextarea.value.trim().length > 0 || selectedMediaFiles.length > 0 || visitorNameInput.value.trim().length > 0) {
                sendCommentBtn.classList.remove('send-btn-inactive');
            } else {
                sendCommentBtn.classList.add('send-btn-inactive');
            }
        }
        
        if (addMediaBtn) {
            addMediaBtn.addEventListener('click', () => {
                mediaFileInput.click();
            });
        }
        
        mediaFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            for(let i = 0; i < files.length; i++) {
                selectedMediaFiles.push(files[i]);
            }
            updateMediaPreviews();
            e.target.value = '';
        });
        
        function updateMediaPreviews() {
            if (!mediaPreviewContainer) return;
            mediaPreviewContainer.innerHTML = '';
            selectedMediaFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.createElement('div');
                    preview.className = 'media-preview-item';
                    const fileType = file.type.startsWith('video') ? 'video' : 'img';
                    preview.innerHTML = `
                        <${fileType} src="${e.target.result}" ${fileType === 'video' ? 'controls' : ''}></${fileType}>
                        <button class="remove-media-btn" data-index="${index}"><i class="fas fa-times"></i></button>
                    `;
                    mediaPreviewContainer.appendChild(preview);
                };
                reader.readAsDataURL(file);
            });
            mediaPreviewContainer.querySelectorAll('.remove-media-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const indexToRemove = e.target.closest('button').getAttribute('data-index');
                    selectedMediaFiles.splice(indexToRemove, 1);
                    updateMediaPreviews();
                    checkInput();
                });
            });
        }
        
        if (sendCommentBtn) {
            sendCommentBtn.addEventListener('click', async () => {
                const name = visitorNameInput.value.trim();
                const text = commentTextarea.value.trim();
                
                if (!name) {
                    showNotification("Please enter your name.");
                    return;
                }
                if (!text && selectedMediaFiles.length === 0) {
                    showNotification("Please write a comment or upload a file.");
                    return;
                }
                
                localStorage.setItem('userName', name);
                sendCommentBtn.disabled = true;

                if (!postOwnerUid || !postId) {
                    showNotification("Error: Post data not found.");
                    sendCommentBtn.disabled = false;
                    return;
                }
                
                const uploadedMediaLinks = await uploadMediaToImgur(selectedMediaFiles);
                let newCommentData;
                
                if (replyingToOriginalCommentId) {
                    newCommentData = {
                        userId: localUserId,
                        fullName: name,
                        commentText: text || '',
                        imageLink1: uploadedMediaLinks[0] || '',
                        imageLink2: uploadedMediaLinks[1] || '',
                        imageLink3: uploadedMediaLinks[2] || '',
                        videoComment: (uploadedMediaLinks[0] && selectedMediaFiles[0]?.type.startsWith('video/')) ? uploadedMediaLinks[0] : '',
                        replyTime: new Date().toISOString(),
                        replyingToCommentId: replyingToOriginalCommentId,
                        replyingToReplyId: replyingToParentReplyId,
                        replyingToReplyUserFullName: replyingToUserFullName || 'Unknown User',
                        commentLike: 0,
                        commentEmoji: '',
                    };
                } else {
                    newCommentData = {
                        userId: localUserId,
                        fullName: name,
                        commentText: text || '',
                        imageLink1: uploadedMediaLinks[0] || '',
                        imageLink2: uploadedMediaLinks[1] || '',
                        imageLink3: uploadedMediaLinks[2] || '',
                        videoComment: (uploadedMediaLinks[0] && selectedMediaFiles[0]?.type.startsWith('video/')) ? uploadedMediaLinks[0] : '',
                        commentTime: new Date().toISOString(),
                        commentLike: 0,
                        commentEmoji: '',
                        replies: {},
                    };
                }
                
                let commentRef;
                if (replyingToOriginalCommentId) {
                    commentRef = ref(db, `users/${postOwnerUid}/Posting/${postId}/PostingComments/${replyingToOriginalCommentId}/replies`);
                    const newReplyRef = push(commentRef);
                    await set(newReplyRef, newCommentData);
                } else {
                    commentRef = ref(db, `users/${postOwnerUid}/Posting/${postId}/PostingComments`);
                    const newCommentRef = push(commentRef);
                    await set(newCommentRef, newCommentData);
                }
                
                try {
                    await runTransaction(ref(db, `users/${postOwnerUid}/Posting/${postId}/totalComment`), (currentComment) => {
                        return (currentComment || 0) + 1;
                    });
                    
                    commentTextarea.value = '';
                    commentTextarea.style.height = '36px';
                    selectedMediaFiles = [];
                    updateMediaPreviews();
                    cancelReply();
                    checkInput();
                    
                } catch (error) {
                    console.error("Error writing comment/reply:", error);
                    showNotification("Failed to send comment. Please check your network.");
                } finally {
                    sendCommentBtn.disabled = false;
                }
            });
        }
        
        if (cancelReplyBtn) {
            cancelReplyBtn.addEventListener('click', cancelReply);
        }
        
        function cancelReply() {
            replyingToOriginalCommentId = null;
            replyingToParentReplyId = null;
            replyingToUserFullName = null; // Resetting the global variable
            if (commentTextarea) commentTextarea.placeholder = "Write a comment...";
            if (replyToContainer) replyToContainer.classList.add('hidden');
        }
        
        async function uploadMediaToImgur(files) {
            const uploadedLinks = [];
            const clientId = "5acf7eff9c91660";
            for (const file of files) {
                const formData = new FormData();
                formData.append("image", file);
                try {
                    const response = await fetch("https://api.imgur.com/3/image", {
                        method: "POST",
                        headers: {
                            Authorization: `Client-ID ${clientId}`
                        },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success && data.data && data.data.link) {
                        uploadedLinks.push(data.data.link);
                    } else {
                        console.error("Imgur upload failed:", data);
                        showNotification(`Failed to upload media.`);
                    }
                } catch (error) {
                    console.error("Imgur upload error:", error);
                    showNotification("Failed to upload media. Please check your network.");
                }
            }
            return uploadedLinks;
        }
    });
    
    /* --- Site 3: Comment Rendering and Actions --- */

    function listenCommentsRealtime() {
        if (!postOwnerUid || !postId) {
            console.warn("Post data not set, cannot listen for comments.");
            return;
        }
        const commentsRef = ref(db, `users/${postOwnerUid}/Posting/${postId}/PostingComments`);
        onValue(commentsRef, (snapshot) => {
            const comments = snapshot.val();
            const commentsArray = [];
            if (comments) {
                for (const key in comments) {
                    commentsArray.push({ ...comments[key], id: key });
                }
            }
            commentsArray.sort((a, b) => new Date(b.commentTime) - new Date(a.commentTime));
            commentsCache = commentsArray;
            renderComments();
        });
    }

    function renderComments() {
        if (!allCommentsContainer) return;
        allCommentsContainer.innerHTML = '';
        commentsCache.forEach(comment => {
            const commentElement = createCommentElement(comment);
            allCommentsContainer.appendChild(commentElement);
        });
    }

    function createCommentElement(comment) {
        const commentCard = document.createElement('div');
        commentCard.className = `comment-card`;
        commentCard.dataset.commentId = comment.id;
        
        const isUserComment = comment.userId === localUserId;
        let mediaHtml = renderMedia(comment);
        let displayCommentText = comment.commentText || '';
        let hasMoreCommentText = false;
        if (displayCommentText.length > MAX_COMMENT_TEXT_LENGTH) {
            displayCommentText = displayCommentText.substring(0, MAX_COMMENT_TEXT_LENGTH) + '...';
            hasMoreCommentText = true;
        }
        commentCard.innerHTML = `
            <div class="comment-header">
                <div class="comment-header-main">
                    <img src="${comment.avatarUrl || 'https://i.imgur.com/lwddsvh.png'}" alt="Profile" class="comment-profile-photo" data-profile-photo="${comment.avatarUrl || 'https://i.imgur.com/lwddsvh.png'}" data-support-team="${comment.supportTeams || ''}">
                    <span class="comment-user-name">${comment.fullName || 'Unknown User'}</span>
                </div>
                <span class="comment-time">${formatTime(comment.commentTime)}</span>
            </div>
            <div class="comment-content" data-fulltext="${encodeURIComponent(comment.commentText)}">
                ${comment.commentText ? `<p class="comment-text">${displayCommentText}</p>` : ''}
                ${hasMoreCommentText ? `<span class="read-more">Read More</span>` : ''}
                ${mediaHtml}
            </div>
            <div class="comment-actions">
                <button class="comment-action-btn like-btn" data-id="${comment.id}"><i class="fas fa-thumbs-up"></i> <span class="like-count">${comment.commentLike || 0}</span></button>
                
                <button class="comment-action-btn reply-btn" data-id="${comment.id}">Reply</button>
                ${isUserComment ? `<button class="comment-action-btn more-options-btn"><i class="fas fa-ellipsis-v"></i></button>` : ''}
            </div>
            <div class="edit-delete-actions" style="display: none;">
                <button class="edit-btn">Edit</button>
                <button class="delete-btn">Delete</button>
            </div>
            <div class="emoji-container" style="display: none;"></div>
        `;
        if (comment.replies) {
            const repliesContainer = document.createElement('div');
            repliesContainer.className = 'replies-container';
            const repliesArray = Object.keys(comment.replies).map(key => ({ ...comment.replies[key], id: key }));
            repliesArray.sort((a, b) => new Date(a.replyTime) - new Date(b.replyTime));
            
            repliesArray.forEach(reply => {
                const replyElement = createReplyElement(reply, comment);
                repliesContainer.appendChild(replyElement);
            });
            commentCard.appendChild(repliesContainer);
        }
        
        if(commentCard.querySelector('.reply-btn')) {
            commentCard.querySelector('.reply-btn').addEventListener('click', (e) => {
                const commentId = e.currentTarget.dataset.id;
                handleReply(commentId, null);
            });
        }
        if(commentCard.querySelector('.like-btn')) {
            commentCard.querySelector('.like-btn').addEventListener('click', () => {
                handleLike(comment.id);
            });
        }
        if(commentCard.querySelector('.emoji-btn')) {
            commentCard.querySelector('.emoji-btn').addEventListener('click', (e) => {
                handleEmojiClick(e, comment.id, 'comment');
            });
        }
        
        const readMoreBtn = commentCard.querySelector('.read-more');
        if (readMoreBtn) {
            readMoreBtn.addEventListener('click', () => {
                const fullText = decodeURIComponent(commentCard.querySelector('.comment-content').dataset.fulltext);
                commentCard.querySelector('.comment-text').textContent = fullText;
                readMoreBtn.style.display = 'none';
            });
        }
        
        if (isUserComment) {
            const moreOptionsBtn = commentCard.querySelector('.more-options-btn');
            const editDeleteActionsDiv = commentCard.querySelector('.edit-delete-actions');
            if (moreOptionsBtn && editDeleteActionsDiv) {
                moreOptionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editDeleteActionsDiv.style.display = editDeleteActionsDiv.style.display === 'none' ? 'flex' : 'none';
                });
            }
            if(commentCard.querySelector('.edit-btn')) {
                commentCard.querySelector('.edit-btn').addEventListener('click', () => handleEdit(comment.id, comment.commentText));
            }
            if(commentCard.querySelector('.delete-btn')) {
                commentCard.querySelector('.delete-btn').addEventListener('click', () => handleDelete(comment.id));
            }
        }
        commentCard.querySelectorAll('.comment-media-item').forEach(item => {
            item.addEventListener('click', () => openImageViewer(item.src));
        });
        
        return commentCard;
    }
    
    function createReplyElement(reply, parentComment) {
        const replyCard = document.createElement('div');
        replyCard.className = `reply-card`;
        replyCard.dataset.replyId = reply.id;
        
        const isUserReply = reply.userId === localUserId;
        
        let replyingToHtml = '';
        if (reply.replyingToReplyUserFullName) {
            replyingToHtml = `<span class="reply-to-text">reply to</span> <span class="reply-by-user-name">${reply.replyingToReplyUserFullName}</span>`;
        } else {
            replyingToHtml = `<span class="reply-to-text">reply to</span> <span class="reply-by-user-name">${parentComment.fullName}</span>`;
        }
        
        let mediaHtml = renderMedia(reply);
        let displayReplyText = reply.commentText || '';
        let hasMoreReplyText = false;
        if (displayReplyText.length > MAX_COMMENT_TEXT_LENGTH) {
            displayReplyText = displayReplyText.substring(0, MAX_COMMENT_TEXT_LENGTH) + '...';
            hasMoreReplyText = true;
        }
        replyCard.innerHTML = `
            <div class="comment-header">
                <div class="comment-header-main">
                    <img src="${reply.avatarUrl || 'https://i.imgur.com/lwddsvh.png'}" alt="Profile" class="comment-profile-photo" data-profile-photo="${reply.avatarUrl || 'https://i.imgur.com/lwddsvh.png'}" data-support-team="${reply.supportTeams || ''}">
                    <span class="comment-user-name">${reply.fullName || 'Unknown User'}</span>
                    ${replyingToHtml}
                </div>
                <span class="comment-time">${formatTime(reply.replyTime)}</span>
            </div>
            <div class="comment-content" data-fulltext="${encodeURIComponent(reply.commentText)}">
                ${reply.commentText ? `<p class="comment-text">${displayReplyText}</p>` : ''}
                ${hasMoreReplyText ? `<span class="read-more">Read More</span>` : ''}
                ${mediaHtml}
            </div>
            <div class="comment-actions">
                <button class="comment-action-btn like-btn" data-id="${reply.id}"><i class="fas fa-thumbs-up"></i> <span class="like-count">${reply.commentLike || 0}</span></button>
               
                <button class="comment-action-btn reply-btn" data-id="${reply.id}" data-parent-id="${parentComment.id}">Reply</button>
                ${isUserReply ? `<button class="comment-action-btn more-options-btn"><i class="fas fa-ellipsis-v"></i></button>` : ''}
            </div>
            <div class="edit-delete-actions" style="display: none;">
                <button class="edit-btn">Edit</button>
                <button class="delete-btn">Delete</button>
            </div>
            <div class="emoji-container" style="display: none;"></div>
        `;
        
        if (replyCard.querySelector('.reply-btn')) {
            replyCard.querySelector('.reply-btn').addEventListener('click', (e) => {
                const replyId = e.currentTarget.dataset.id;
                const parentId = e.currentTarget.dataset.parentId;
                handleReply(parentId, replyId);
            });
        }
        if (replyCard.querySelector('.like-btn')) {
            replyCard.querySelector('.like-btn').addEventListener('click', () => {
                handleLikeReply(parentComment.id, reply.id);
            });
        }
        if (replyCard.querySelector('.emoji-btn')) {
            replyCard.querySelector('.emoji-btn').addEventListener('click', (e) => {
                handleEmojiClick(e, reply.id, 'reply', parentComment.id);
            });
        }
        const readMoreBtn = replyCard.querySelector('.read-more');
        if (readMoreBtn) {
            readMoreBtn.addEventListener('click', () => {
                const fullText = decodeURIComponent(replyCard.querySelector('.comment-content').dataset.fulltext);
                replyCard.querySelector('.comment-text').textContent = fullText;
                readMoreBtn.style.display = 'none';
            });
        }
        
        if (isUserReply) {
            const moreOptionsBtn = replyCard.querySelector('.more-options-btn');
            const editDeleteActionsDiv = replyCard.querySelector('.edit-delete-actions');
            if (moreOptionsBtn && editDeleteActionsDiv) {
                moreOptionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editDeleteActionsDiv.style.display = editDeleteActionsDiv.style.display === 'none' ? 'flex' : 'none';
                });
            }
            if(replyCard.querySelector('.edit-btn')) {
                replyCard.querySelector('.edit-btn').addEventListener('click', () => handleEditReply(parentComment.id, reply.id, reply.commentText));
            }
            if(replyCard.querySelector('.delete-btn')) {
                replyCard.querySelector('.delete-btn').addEventListener('click', () => handleDeleteReply(parentComment.id, reply.id));
            }
        }
        replyCard.querySelectorAll('.comment-media-item').forEach(item => {
            item.addEventListener('click', () => openImageViewer(item.src));
        });
        return replyCard;
    }

    function renderMedia(item) {
        let mediaHtml = '';
        if (item.videoComment) {
            mediaHtml += `<div class="media-preview-item"><video src="${item.videoComment}" controls></video></div>`;
        }
        if (item.imageLink1) mediaHtml += `<div class="media-preview-item"><img src="${item.imageLink1}" class="comment-media-item" /></div>`;
        if (item.imageLink2) mediaHtml += `<div class="media-preview-item"><img src="${item.imageLink2}" class="comment-media-item" /></div>`;
        if (item.imageLink3) mediaHtml += `<div class="media-preview-item"><img src="${item.imageLink3}" class="comment-media-item" /></div>`;
        return mediaHtml ? `<div class="comment-media-container">${mediaHtml}</div>` : '';
    }

    function handleLike(commentId) {
        if (!postOwnerUid || !postId) return;
        const commentRef = ref(db, `users/${postOwnerUid}/Posting/${postId}/PostingComments/${commentId}`);
        runTransaction(commentRef, (comment) => {
            if (comment) {
                comment.commentLike = (comment.commentLike || 0) + 1;
            }
            return comment;
        });
    }

    function handleLikeReply(commentId, replyId) {
        if (!postOwnerUid || !postId) return;
        const replyRef = ref(db, `users/${postOwnerUid}/Posting/${postId}/PostingComments/${commentId}/replies/${replyId}`);
        runTransaction(replyRef, (reply) => {
            if (reply) {
                reply.commentLike = (reply.commentLike || 0) + 1;
            }
            return reply;
        });
    }
    
    
    

    function handleReply(commentId, replyId = null) {
        let targetName = 'Unknown User';
        let targetCommentText = '';

        if (replyId) {
            // Wannan yana faruwa ne idan an danna reply a kan wani reply
            const parentComment = commentsCache.find(c => c.id === commentId);
            const targetReply = parentComment?.replies[replyId];
            if (targetReply) {
                targetName = targetReply.fullName;
                targetCommentText = targetReply.commentText || '';
            }
            replyingToOriginalCommentId = commentId;
            replyingToParentReplyId = replyId;
        } else {
            // Wannan yana faruwa ne idan an danna reply a kan babban comment
            const targetComment = commentsCache.find(c => c.id === commentId);
            if (targetComment) {
                targetName = targetComment.fullName;
                targetCommentText = targetComment.commentText || '';
            }
            replyingToOriginalCommentId = commentId;
            replyingToParentReplyId = null;
        }

        replyingToUserFullName = targetName;
        document.getElementById('reply-to-name').textContent = targetName;
        document.getElementById('reply-to-message').textContent = targetCommentText.substring(0, 50) + '...';
        replyToContainer.classList.remove('hidden');
        commentTextarea.focus();
    }
    
       
       
       
    
    function handleEmojiClick(event, id, type, parentId = null) {
        event.stopPropagation();
        const existingPicker = document.querySelector('.emoji-picker-container.visible');
        if (existingPicker) {
            existingPicker.classList.remove('visible');
        }

        const emojiContainer = document.getElementById('emoji-picker-container');
        if (!emojiContainer) return;
        
        emojiContainer.classList.add('visible');
        
        emojiContainer.querySelectorAll('.emoji-icon').forEach(icon => {
            icon.onclick = (e) => {
                e.stopPropagation();
                emojiContainer.classList.remove('visible');
                if (!icon.classList.contains('close-emoji-btn')) {
                    updateEmoji(id, icon.textContent, type, parentId);
                }
            };
        });
    }
    
    function updateEmoji(id, emoji, type, parentId) {
        let path = '';
        if (type === 'comment') {
            path = `users/${postOwnerUid}/Posting/${postId}/PostingComments/${id}`;
        } else if (type === 'reply' && parentId) {
            path = `users/${postOwnerUid}/Posting/${postId}/PostingComments/${parentId}/replies/${id}`;
        }
        
        if (path) {
            const emojiRef = ref(db, path);
            update(emojiRef, {
                commentEmoji: emoji
            });
        }
    }

    async function handleEdit(commentId, oldText) {
        const newText = await showInputModal("Edit Comment", "Enter new text:", oldText);
        if (newText !== null && newText.trim() !== "") {
            const commentRef = ref(db, `users/${postOwnerUid}/Posting/${postId}/PostingComments/${commentId}`);
            update(commentRef, {
                commentText: newText
            }).then(() => {
                showNotification("Comment updated successfully.");
            }).catch(error => {
                console.error("Error updating comment:", error);
                showNotification("Failed to update comment.");
            });
        }
    }

    async function handleDelete(commentId) {
        const confirmed = await showConfirmationModal("Are you sure you want to delete this comment?");
        if (confirmed) {
            const commentRef = ref(db, `users/${postOwnerUid}/Posting/${postId}/PostingComments/${commentId}`);
            remove(commentRef).then(() => {
                showNotification("Comment deleted successfully.");
                runTransaction(ref(db, `users/${postOwnerUid}/Posting/${postId}/totalComment`), (currentValue) => {
                    return (currentValue || 0) - 1;
                });
            }).catch(error => {
                console.error("Error deleting comment:", error);
                showNotification("Failed to delete comment.");
            });
        }
    }
    
    async function handleEditReply(commentId, replyId, oldText) {
        const newText = await showInputModal("Edit Reply", "Enter new text:", oldText);
        if (newText !== null && newText.trim() !== "") {
            const replyRef = ref(db, `users/${postOwnerUid}/Posting/${postId}/PostingComments/${commentId}/replies/${replyId}`);
            update(replyRef, {
                commentText: newText
            }).then(() => {
                showNotification("Reply updated successfully.");
            }).catch(error => {
                console.error("Error updating reply:", error);
                showNotification("Failed to update reply.");
            });
        }
    }

    async function handleDeleteReply(commentId, replyId) {
        const confirmed = await showConfirmationModal("Are you sure you want to delete this reply?");
        if (confirmed) {
            const replyRef = ref(db, `users/${postOwnerUid}/Posting/${postId}/PostingComments/${commentId}/replies/${replyId}`);
            remove(replyRef).then(() => {
                showNotification("Reply deleted successfully.");
                runTransaction(ref(db, `users/${postOwnerUid}/Posting/${postId}/totalComment`), (currentValue) => {
                    return (currentValue || 0) - 1;
                });
            }).catch(error => {
                console.error("Error deleting reply:", error);
                showNotification("Failed to delete reply.");
            });
        }
    }
    
    function showInputModal(title, message, defaultValue = "") {
        return new Promise((resolve) => {
            const modal = document.getElementById('input-modal');
            if (!modal) {
                console.error("Input modal element not found.");
                resolve(null);
                return;
            }
            modal.querySelector('.modal-title').textContent = title;
            modal.querySelector('.modal-message').textContent = message;
            const input = modal.querySelector('.modal-input');
            input.value = defaultValue;
            modal.classList.add('visible');
            
            modal.querySelector('.confirm-btn').onclick = () => {
                resolve(input.value);
                modal.classList.remove('visible');
            };
            modal.querySelector('.cancel-btn').onclick = () => {
                resolve(null);
                modal.classList.remove('visible');
            };
        });
    }

    function showConfirmationModal(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirmation-modal');
            if (!modal) {
                console.error("Confirmation modal element not found.");
                resolve(false);
                return;
            }
            modal.querySelector('.modal-message').textContent = message;
            modal.classList.add('visible');
            modal.querySelector('.confirm-btn').onclick = () => {
                resolve(true);
                modal.classList.remove('visible');
            };
            modal.querySelector('.cancel-btn').onclick = () => {
                resolve(false);
                modal.classList.remove('visible');
            };
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadPostAndComments();
    });
    
    document.addEventListener('click', (e) => {
        const emojiContainers = document.querySelectorAll('.emoji-picker-container');
        emojiContainers.forEach(container => {
            if (container && !container.contains(e.target) && !e.target.classList.contains('emoji-btn')) {
                container.classList.remove('visible');
            }
        });
    });               
   
</script>
</body>
</html>